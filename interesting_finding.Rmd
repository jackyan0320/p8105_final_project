---
title: ""
output: 
  html_document:
    theme:  united
    css: interesting_finding.css
    number_sections: FALSE
    code_folding: hide
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("DT")
library(DT)
library(tidyverse)
library(httr)
library(plotly)
library(HH)
```

<a href="https://github.com/jackyan0320/p8105_final_project" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#dd4814; color:#fff; position: absolute; top: 50; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}} </style>

```{r data process chuck, message=F, warning=F, include=F}
organ =
  read_csv("./data/organ.csv") %>% 
  filter(county != "TOTAL NYS") 
demo_ny = 
  read.csv("./data/ahrf_select_data.csv") %>% as.tibble() %>% 
  janitor::clean_names() %>% 
  rename(county = county_name) 
```

<div style="margin-bottom:50px;">
</div>

# Fun Findings {.tabset .tabset-fade .tabset-pills}
about donners in NY

<div style="margin-bottom:30px;">
</div>

## Registration Over Time 

<div style="margin-bottom:30px;">
</div>

The registry enrollments showed a generally increasing trend across the years. However, note that there is a sudden change in registry enrollments on 2009-06-01 and 2017-10-1. Curiously, the enrollment even declined for some counties on 2017-10-1, which indicates an aspect of limitation of the dataset.
```{r}
county_enrollment_plot = 
  organ %>% 
  ggplot(aes(x = date, y = registry_enrollments, color = county)) +
    geom_line() +
    labs(x = "Date", 
         y = "Persons enrolled", 
         title = "Registry enrollments across time")

ggplotly(county_enrollment_plot)
```

<div style="margin-bottom:20px;">
</div>


This plot shows the trend of registration rate from 2008 to 2018 for counties in New York State. Note that the registration rates for Counties Cattauragus and St Lawrence were not updated throughout the years.
     
```{r message = F, warning= F}
county_enrollment_rate_plot = 
  organ %>% 
  ggplot(aes(x = date, y = eligible_population_enrolled, color = county)) +
    geom_line() +
    labs(x = "Date", 
         y = "% Persons enrolled", 
         title = "Registration rate across time")
ggplotly(county_enrollment_rate_plot)
```

There was a huge leap in pupulation_18_estimate at 2017-10-01 among almost all the counties





## Pop vs Enroll

<div style="margin-bottom:20px;">
</div>

### More populated state has more people enroll but less percentage of people enroll

<div style = "float: left; width : 50%; margin-left: -20%">
```{r message = F, warning= F}
lowest_3_counties = organ %>% 
  filter(date == as.Date("2018-09-01")) %>% 
  filter(county != "TOTAL NYS") %>%
  arrange(eligible_population_enrolled) %>%
  top_n(n = -3, eligible_population_enrolled)

trend_1 = 
  organ %>%
  # only use data after 2017-10-01
  filter(date == '2018-09-01') %>% 
  mutate(text_label = str_c("Eligible pop:", population_18_estimate, '\nregistry_enrollments: ',  registry_enrollments, "\nCounty:", county, "\ndate:", date)) %>% 
  plot_ly(x = ~population_18_estimate, 
          y = ~registry_enrollments, 
          type = "scatter", 
          mode = "markers",
          color = ~county,
          text = ~text_label) 
trend_1 

plot_enrollments_population = 
  organ %>%
  filter(date == '2018-09-01') %>% 
  ggplot(aes(x = population_18_estimate, y = registry_enrollments)) +
  geom_point(aes(group = county)) +
  geom_smooth(method = 'auto', se = FALSE) +
  theme_bw() 
ggplotly(plot_enrollments_population)

```
</div>

<div style = "float: right; width : 50%"> 
```{r message = F, warning= F}

trend_2 = 
  organ %>%
  # only use data after 2017-10-01
  filter(date == '2018-09-01') %>% 
  mutate(text_label = str_c("Eligible pop:", population_18_estimate, '\nregistry_enrollments: ',  registry_enrollments, "\nCounty:", county, "\ndate:", date)) %>% 
  plot_ly(x = ~population_18_estimate, 
          y = ~eligible_population_enrolled, 
          type = "scatter", 
          mode = "markers",
          color = ~county,
          text = ~text_label) %>% 
  add_annotations(x = lowest_3_counties$population_18_estimate , 
                  y = lowest_3_counties$eligible_population_enrolled, 
                  text = lowest_3_counties$county)
trend_2

plot_enrollments_population = 
  organ %>%
  filter(date == '2018-09-01') %>% 
  ggplot(aes(x = population_18_estimate, y = eligible_population_enrolled)) +
  geom_point(aes(group = county)) +
  geom_smooth(method = 'auto', se = FALSE) +
  theme_bw()
ggplotly(plot_enrollments_population)
```
</div>

```{r message = F, warning= F}

```

## Education

<div style="margin-bottom:20px;">
</div>


      L
## Agency

<div style="margin-bottom:20px;">
</div>


      L
## Month

<div style="margin-bottom:20px;">
</div>


      L
## Age

<div style="margin-bottom:20px;">
</div>


      L
  
## Method 

<div style="margin-bottom:20px;">
</div>


To fit a regression model, use the data of Sep 2018 only.

```{r message = F, warning= F}
organ_2018_sep =
  organ %>%
  filter(date > '2017-10-01') %>% 
  filter(month == 9) 


```

Combine the demo and donor datasets.

```{r message = F, warning= F}
variables_list = read_csv("./data/ahrf_selected_variables.csv")$label

regression_df = 
  inner_join(by = 'county', organ_2018_sep, demo_ny) %>% 
  dplyr::select(opo, population_18_estimate, registry_enrollments, eligible_population_enrolled,
         standardzd_per_capita_medcr_cost_fee_for_service_2015:percent_educ_hlth_care_soc_asst_2011_15) %>% 
  mutate(opo = fct_relevel(opo, "New York Organ Donor Network")) %>% 
  mutate(
    pop_total_2015 =  (pop_total_female_2015 + pop_total_male_2015) ,
    percent_male_2015 = (100 * (pop_total_male_2015 / pop_total_2015)) %>% round(., digits = 2),
    percent_white_2015 = (100 * (pop_white_female_2015 + pop_white_male_2015) / pop_total_2015) %>% round(., digits = 2),
    percent_black_2015 = (100 * (pop_black_african_amer_female_2015 + pop_black_african_amer_male_2015) / pop_total_2015) %>% round(., digits = 2) ,
    percent_asian_2015 = (100 * (pop_asian_female_2015 + pop_asian_male_2015) / pop_total_2015) %>% round(., digits = 2),
    percent_medicare_enrollment_2015 = (medicare_enrollment_aged_tot_2015 * 100 / pop_total_2015) %>% round(., digits = 2)
  ) %>% 
  dplyr::select(-(pop_total_male_2015:pop_asian_female_2015), -population_estimate_2016, -medicare_enrollment_aged_tot_2015) %>% 
  dplyr::select(eligible_population_enrolled, everything()) %>% 
  rename(percent_enrolled = eligible_population_enrolled)

```

Fit a model

```{r message = F, warning= F}

lm(percent_enrolled ~ ., regression_df) %>% broom::tidy() %>% 
  knitr::kable()

  # use 'New York Organ Donor Network' as the reference group for opo
fit_final = 
  lm(percent_enrolled ~ opo + percent_medicare_enrollment_2015 + percent_male_2015 + percent_white_2015*percent_persons_25_w_hs_diploma_2011_15 + percent_persons_25_w_4_yrs_college_2011_15, data = regression_df) 
 
fit_final %>%  broom::tidy() %>% 
  knitr::kable()
fit_final %>% summary 
par(mfrow = c(2,2))
plot(fit_final)
```

This model 

```{r message = F, warning= F}
## Bootstrapping
regression_df %>% 
  modelr::bootstrap(n = 1000) %>% 
  mutate(models = map(strap, ~lm(percent_enrolled ~ opo + percent_medicare_enrollment_2015 + percent_male_2015 + percent_white_2015*percent_persons_25_w_hs_diploma_2011_15 + percent_persons_25_w_4_yrs_college_2011_15, data = .x)),
         results = map(models, broom::tidy)) %>% 
  dplyr::select(-strap, -models) %>% 
  unnest() %>% filter(term != "(Intercept)") %>% 
  group_by(term) %>% 
  summarize(boot_mean = mean(estimate),
            boot_se = sd(estimate)) %>% 
  mutate(cv = boot_se/boot_mean) %>% 
  knitr::kable()

## Cross Validation
library(modelr)
cv_df = 
  crossv_mc(regression_df, 100) 

cv_df = 
  cv_df %>% 
  mutate(model = map(train, ~lm(percent_enrolled ~ opo + percent_medicare_enrollment_2015 + percent_male_2015 + percent_white_2015*percent_persons_25_w_hs_diploma_2011_15 + percent_persons_25_w_4_yrs_college_2011_15, data = .x))) %>% 
  mutate(rmse = map2_dbl(model, test, ~rmse(model = .x, data = .y)))
cv_df %>% 
  ggplot(aes(x = 'model', y = rmse)) + geom_violin()
```


<br />
<br />
<br />
<br />


</div>

<div style="margin-bottom:50px;">
</div>










```{r}
# DATA TABLE (optional)
```

<br />
<br />

```{r echo=FALSE, include = FALSE}
datatable(regression_df, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T) )
```
      
      