---
title: "association_demo_registration"
author: "Jack Yan"
date: "11/20/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(httr)
library(plotly)
library(HH)
```

# Data manipulation

### Load organ registration data

```{r, message = F}
organ =
  read_csv("./data/organ.csv") %>% 
  filter(county != "TOTAL NYS") 

```

### Load demographic data

```{r}
demo_ny = 
  read.csv("./data/ahrf_select_data.csv") %>% as.tibble() %>% 
  janitor::clean_names() %>% 
  rename(county = county_name) 
```

# EDA
## Data inspection

####The registry enrollments showed a generally increasing trend across the years. However, note that there is a sudden change in registry enrollments on 2009-06-01 and 2017-10-1. Curiously, the enrollment even declined for some counties on 2017-10-1, which indicates an aspect of limitation of the dataset. 

```{r}
county_enrollment_plot = 
  organ %>% 
  ggplot(aes(x = date, y = registry_enrollments, color = county)) +
    geom_line() +
    labs(x = "Date", 
         y = "Persons enrolled", 
         title = "Registry enrollments across time")

ggplotly(county_enrollment_plot)
```

This plot shows the trend of registration rate from 2008 to 2018 for counties in New York State. Note that the registration rates for Counties Cattauragus and St Lawrence were not updated throughout the years.

```{r}
county_enrollment_rate_plot = 
  organ %>% 
  ggplot(aes(x = date, y = eligible_population_enrolled, color = county)) +
    geom_line() +
    labs(x = "Date", 
         y = "% Persons enrolled", 
         title = "Registration rate across time")
ggplotly(county_enrollment_rate_plot)
```

## Relationship between population size and registration enrollment (rate) in 2017-10-01

```{r}
organ %>%
  # only use data after 2017-10-01
  filter(date == '2018-09-01') %>% 
  mutate(text_label = str_c("Eligible pop:", population_18_estimate, '\nregistry_enrollments: ',  registry_enrollments, "\nCounty:", county, "\ndate:", date)) %>% 
  plot_ly(x = ~population_18_estimate, y = ~registry_enrollments, type = "scatter", mode = "markers",
          color = ~county,
          text = ~text_label)

```

# Regression model

To fit a regression model, use the data of Sep 2018 only.

```{r}
organ_2018_sep =
  organ %>%
  filter(date > '2017-10-01') %>% 
  filter(month == 9) 


```

## Combine the demo and donor datasets.

```{r}
variables_list = read_csv("./data/ahrf_selected_variables.csv")$label

regression_df_county = 
  inner_join(by = 'county', organ_2018_sep, demo_ny) %>% 
  dplyr::select(county, opo, population_18_estimate, registry_enrollments, eligible_population_enrolled,
         standardzd_per_capita_medcr_cost_fee_for_service_2015:percent_educ_hlth_care_soc_asst_2011_15) %>% 
  mutate(opo = fct_relevel(opo, "New York Organ Donor Network")) %>% 
  mutate(
    pop_total_2015 =  (pop_total_female_2015 + pop_total_male_2015) ,
    percent_male_2015 = (100 * (pop_total_male_2015 / pop_total_2015)) %>% round(., digits = 2),
    percent_white_2015 = (100 * (pop_white_female_2015 + pop_white_male_2015) / pop_total_2015) %>% round(., digits = 2),
    percent_black_2015 = (100 * (pop_black_african_amer_female_2015 + pop_black_african_amer_male_2015) / pop_total_2015) %>% round(., digits = 2) ,
    percent_asian_2015 = (100 * (pop_asian_female_2015 + pop_asian_male_2015) / pop_total_2015) %>% round(., digits = 2),
    percent_medicare_enrollment_2015 = (medicare_enrollment_aged_tot_2015 * 100 / pop_total_2015) %>% round(., digits = 2)
  ) %>% 
  dplyr::select(-(pop_total_male_2015:pop_asian_female_2015), -population_estimate_2016, -medicare_enrollment_aged_tot_2015) %>% 
  dplyr::select(county, eligible_population_enrolled, everything()) %>% 
  rename(percent_enrolled = eligible_population_enrolled)

regression_df =
  regression_df_county %>% 
  dplyr::select(-county)
  
regression_df_county
```

## Plots btw association rate and county demographics

```{r}
regression_df_county 
  
```

## Fit a model

```{r}

lm(percent_enrolled ~ ., regression_df) %>% broom::tidy()

  # use 'New York Organ Donor Network' as the reference group for opo
fit_final = 
  lm(percent_enrolled ~ opo + percent_medicare_enrollment_2015 + percent_male_2015 + percent_white_2015*percent_persons_25_w_hs_diploma_2011_15 + percent_persons_25_w_4_yrs_college_2011_15, data = regression_df) 
 
fit_final %>%  broom::tidy()
fit_final %>% summary

```

This model 

## Model validation 

```{r}
## Bootstrapping
regression_df %>% 
  modelr::bootstrap(n = 1000) %>% 
  mutate(models = map(strap, ~lm(percent_enrolled ~ opo + percent_medicare_enrollment_2015 + percent_male_2015 + percent_white_2015*percent_persons_25_w_hs_diploma_2011_15 + percent_persons_25_w_4_yrs_college_2011_15, data = .x)),
         results = map(models, broom::tidy)) %>% 
  dplyr::select(-strap, -models) %>% 
  unnest() %>% filter(term != "(Intercept)") %>% 
  group_by(term) %>% 
  summarize(boot_mean = mean(estimate),
            boot_se = sd(estimate)) %>% 
  mutate(cv = boot_se/boot_mean)

## Cross Validation
library(modelr)
cv_df = 
  crossv_mc(regression_df, 100) 

cv_df = 
  cv_df %>% 
  mutate(model = map(train, ~lm(percent_enrolled ~ opo + percent_medicare_enrollment_2015 + percent_male_2015 + percent_white_2015*percent_persons_25_w_hs_diploma_2011_15 + percent_persons_25_w_4_yrs_college_2011_15, data = .x))) %>% 
  mutate(rmse = map2_dbl(model, test, ~rmse(model = .x, data = .y)))
cv_df %>% 
  ggplot(aes(x = 'model', y = rmse)) + geom_violin()
```

## Diagnostics

```{r}
par(mfrow = c(2,2))
plot(fit_final)
```

