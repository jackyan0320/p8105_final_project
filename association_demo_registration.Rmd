---
title: "association_demo_registration"
author: "Jack Yan"
date: "11/20/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(httr)
library(plotly)
```

# Load registration data

```{r}
organ =
read_csv("./data/organ.csv") %>% 
  filter(county != "TOTAL NYS") %>% 
  mutate(
    reg_rate = registry_enrollments / population_18_estimate
  )

# read_csv("./data/state_donor_share.csv") 
```

# Load demographic data

```{r}
demo_ny = 
  read.csv("./data/ahrf_select_data.csv") %>% as.tibble() %>% 
  janitor::clean_names() %>% 
  rename(county = county_name) %>% 
  filter(state_name_abbreviation == "NY") 
```

```{r}
county_enrollment_plot = 
  organ %>% 
  ggplot(aes(x = date, y = registry_enrollments, color = county)) +
    geom_line() 
ggplotly(county_enrollment_plot)

county_enrollment_rate_plot = 
  organ %>% 
  ggplot(aes(x = date, y = reg_rate, color = county)) +
    geom_line() 
ggplotly(county_enrollment_rate_plot)

population_enrollment_plot =  
  organ %>% 
  ggplot(aes(y = registry_enrollments, x = population_18_estimate, color = county)) +
    geom_point() 
ggplotly(population_enrollment_plot)


# There was a huge leap in pupulation_18_estimate at 2017-10-01 among almost all the counties
organ %>%
  # only use data after 2017-10-01
  filter(date >'2017-10-01') %>% 
  mutate(text_label = str_c("Eligible pop:", population_18_estimate, '\nregistry_enrollments: ', registry_enrollments, "\nCounty:", county, "\ndate:", date)) %>% 
  plot_ly(x = ~population_18_estimate, y = ~registry_enrollments, type = "scatter", mode = "markers",
          #alpha = 0.5, 
          color = ~county,
          text = ~text_label)

# use the data of Sep 2018
organ_2018_sep =
  organ %>%
  # only use data after 2017-10-01
  filter(date > '2017-10-01') %>% 
  filter(month == 9) 

fit = lm(registry_enrollments ~ population_18_estimate, data = organ_2018_sep)
organ_2018_sep %>% 
  mutate(text_label = str_c("Eligible pop:", population_18_estimate, '\nregistry_enrollments: ', registry_enrollments, "\nCounty:", county, "\ndate:", date)) %>% 
  plot_ly(x = ~population_18_estimate, y = ~registry_enrollments, mode = "markers") %>% 
  add_markers(y = ~registry_enrollments) %>% 
  add_trace(x = ~population_18_estimate, y = fitted(fit), mode = "lines") %>%
  layout(showlegend = F)



  
```

This plot doesn't show much information.

```{r, eval = F}
organ_df_sep = 
  organ %>% 
  group_by(county, year) %>% 
  arrange(county, date) %>% 
  mutate(prop_reg_enroll = registry_enrollments / population_18_estimate) #%>% 
 # filter(month == 9) 
 
organ_df_sep %>% 
  ggplot(aes(x = year, y = prop_reg_enroll, group = county, color = county)) +
  geom_line()
```

```{r}
organ_2018_sep

joined_df = inner_join(by = 'county', organ_2018_sep, demo_ny)

```

# plotting

```{r}
variables_list = read_csv("./data/ahrf_selected_variables.csv")$label

regression_df = 
  joined_df %>% 
  select(opo, population_18_estimate, registry_enrollments,
         standardzd_per_capita_medcr_cost_fee_for_service_2015:percent_educ_hlth_care_soc_asst_2011_15) %>% 
  mutate(opo = as.factor(opo)) %>% 
  mutate(pop_total_2015 = pop_total_female_2015 + pop_total_male_2015,
         male_proportion_2015 = pop_total_male_2015 / pop_total_2015,
         white_proportion_2015 = (pop_white_female_2015 + pop_white_male_2015) / pop_total_2015,
         black_proportion_2015 = (pop_black_african_amer_female_2015 + pop_black_african_amer_male_2015) / pop_total_2015
         
  )
plot = 
  regression_df %>% 
  ggplot(aes(y = registry_enrollments, x = pop_total_2015)) +
  geom_point()
ggplotly(plot)
# medicare enrollment is strongly associated with donor registration rate
regression_df %>% 
  lm(registry_enrollments ~  population_18_estimate + pop_total_2015 * medicare_enrollment_aged_tot_2015 + x_persons_25_w_4_yrs_college_2011_15+ male_proportion_2015 + white_proportion_2015 + black_proportion_2015 + percent_educ_hlth_care_soc_asst_2011_15 + opo , data = .) %>% # broom::tidy()
  summary()





regression_df %>% 
  select(-opo) %>% 
  cor() 

```

